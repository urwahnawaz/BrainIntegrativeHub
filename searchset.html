<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    
    <script src="https://kit.fontawesome.com/358fab0097.js" crossorigin="anonymous"></script>

    <script src="https://d3js.org/colorbrewer.v1.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>

    <link href="resources/data/out.hdf5" />
    <script src="https://cdn.jsdelivr.net/gh/usnistgov/jsfive@master/dist/hdf5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script src="resources/js/circviewer.js"></script>
    <script src="resources/js/lmsPanelSet.js"></script>

    <script src="resources/js/plot.js"></script>
    <script src="resources/js/plotControls.js"></script>


    <link rel="stylesheet" href="resources/css/style.css" />
</head>

<body>
    <!-- Loading Animation -->
    <div id="my_loading" class="d-flex flex-row justify-content-center align-items-center" style="height: 100%">
        <!--<div class="loader">
            <span class="sr-only">Loading...</span>
        </div>--> 
        <div class="progress">
            <div id="my_progress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>

    <!-- Main Body -->
    <div>
        <nav id="my_navbar" class="navbar navbar-default navbar-fixed-top" style="border:none;">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand">BITHub</a>
                </div>
                <ul class="nav navbar-nav">
                    <li><a class="nav-link" href="./index.html">About</a></li>
                    <li class="active"><a class="nav-link" href="./searchset.html">Gene Set search</a></li>
                    <li><a class="nav-link" href="./search.html">Single Gene search</a></li>
                    <li><a class="nav-link" href="./download.html">Download</a></li>
                </ul>
            </div>
        </nav>

        <div id="myDiv" style="display:none;" class="container-fluid">
            <!--class animate-bottom-->
            <div>
                  <div class="well">
                    <b> Search </b> BITHub by comma delimited list of Gene Symbols or Ensembl Gene IDs. Select the search field from the drop-down menu on the right.   
                    <br>
                    <b> To download the plot - </b> hover over the plot and select a format.
                    <br>
                    <b> Search using file </b> upload a file containing a line delimited list of Gene Symbols or Ensembl Gene IDs. (<a href="./resources/data/Ensembl-list-example.csv">Example</a>)
                </div>

                
                <div class="row">
                    <div class="col-md-9">
                        <label id="myDisplay" data-domain="">
                            <input type="search" autocomplete="off" class="mySearch" id="myInput">
                        </label>
                    </div>
                    <div class="col-md-1">
                        <input type="file" id="inputData" style="opacity:0;display:contents;" accept=".csv">
                        <button id="inputDataLabel" type="submit" style="color:#009b41;border:none;width: 40px; height: 40px; margin-right:15px; vertical-align: top; width:100%"><i id="inputDataIcon" class="fas fa-file-csv" aria-hidden="true"></i></button>
                    </div>
                    <div class="col-md-1">
                        <span id="my_search_select_group"><select class="selectpicker" data-header="Select searchable parameters" id="my_search_select" multiple></select></span>
                    </div>
                    <div class="col-md-1">
                        <button id="my_search_button" type="submit"><i class="fas fa-search"></i></button>
                    </div>
                  </div>
            </div>

            <!-- Main Table -->

            <br>
            
            <span id="searchsetplot">
                <span></span>
            </span>
        </div>
    </div>

    <script>
        var pinned = []

        let dataOrder = undefined;
        let isDataset = undefined;
        let isDatabase = undefined;
        let isBrainDataset = undefined;

        let matrix = undefined;
        let indices = undefined;
        
        let searchCols = undefined;

        let searchTerm = "";
        let searchFile = false;

        let coordinateStarts = [];
        let coordinateEnds = [];
        let coordinateNames = [];
        let defaultCoord;

        let lmsPanel = undefined;

        //TODO convert to promises. Very hacky 
        var awaitAll = 0;
        function incAwaitAll() {
            if (++awaitAll == 1) {
                hideLoading();
            }
        }

        function resetDropdowns() {
            let optOther = "";
            optOther += '<optgroup label="Column contents" data-max-options="1">';
            for(let i=0; i<dataOrder.length; ++i) if(!isDataset[i] && !isDatabase[i]) optOther += '<option value="' + (i) + '">' + dataOrder[i] + '</option>';
            optOther += '</optgroup>';

            let optSearch = optOther;

            let optAll = optOther;
            optAll += '<optgroup label="Datasets">';
            for(let i=0; i<dataOrder.length; ++i) if(isDataset[i]) optAll += '<option value="' + (i) + '">' + dataOrder[i] + '</option>';
            optAll += '</optgroup>'
            optAll += '<optgroup label="Databases">';
            for(let i=0; i<dataOrder.length; ++i) if(isDatabase[i]) optAll += '<option value="' + (i) + '">' + dataOrder[i] + '</option>';
            optAll += '</optgroup>'

            $("#my_search_select").empty();
            $("#my_search_select").append(optSearch);
            $('#my_search_select').val(searchCols[0]);
            $('#my_search_select').selectpicker('refresh');
            $('#my_search_select').on('change', function(){
                searchCols = $(this).val();
            });

            $(document).ready(function() {
                $(".selectpicker").selectpicker("refresh");
            });
        }

        let windowPath = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
        myProgress = document.getElementById("my_progress");
        (async function downloadFile() {
            const response = await fetch(windowPath + "/resources/data/out.hdf5");
            const length = response.headers.get('Content-Length');
            const buffer = new Uint8Array(length);
            let at = 0;
            const reader = response.body.getReader();
            for (;;) {
                const {done, value} = await reader.read();
                if (done) {
                    break;
                }
                buffer.set(value, at);
                at += value.length;
                let pcg = Math.floor(100 * (at / length));
                myProgress.setAttribute('aria-valuenow',pcg);
                myProgress.setAttribute('style','width:'+Number(pcg)+'%');
            }
            
            //Now we have data in buffer
            var f = new hdf5.File(buffer.buffer, "");

            hdf5Data = f.get("data");
            dataOrder = hdf5Data.attrs.order;
            isDataset = hdf5Data.attrs.isDataset;
            isDatabase = hdf5Data.attrs.isDatabase;
            isBrainDataset = hdf5Data.attrs.isBrainDataset;
            searchCols = hdf5Data.attrs.defaultSearchable;
            
            matrix = [];
            for(let h of dataOrder) matrix.push([...hdf5Data.get(h).value]);

            lmsMeta = {};
            for(let i=0; i<dataOrder.length; ++i) if(isDataset[i]) lmsMeta[dataOrder[i]] = matrix[i];

            resetDropdowns();

            $("#myDisplay")[0].setAttribute('data-domain', matrix[0].length + " transcripts");

            lmsPanel = new LMSPanelSet("searchsetplot", 0, "", f.get("metadata"), lmsMeta, matrix[0]);

            incAwaitAll();
        })();


        $("#myInput").keyup(function (event) {
            if (event.keyCode === 13) {
                searchTerm = $("#myInput").val();
                updatePlot();
            }
        });

        $("#my_search_button").click(function () {
            if(!searchFile) searchTerm = $("#myInput").val();
            updatePlot();
        });

        let inputDataIcon = document.getElementById("inputDataIcon")
        let inputDataFile = document.getElementById("inputData");
        let inputField = document.getElementById("myInput");
        let defaultPlaceholder = 'e.g. "ENSG00000099785, ENSG00000136536, ENSG00000139266, ENSG00000144583"';
        let prevVal = "";
        inputField.placeholder = defaultPlaceholder;
        $("#inputDataLabel").click(function() {
            if(inputDataFile.value) {
                inputDataIcon.classList.replace("fa-minus-circle", "fa-file-csv");
                inputField.disabled = false;
                inputField.placeholder = defaultPlaceholder;
                inputField.value = prevVal;
                inputDataFile.value = null;
                searchFile = false;
            } else {
                
                inputDataFile.click();
            }
        });

        $("#inputData").change(function() {
            if(inputDataFile.value) {
                inputDataIcon.classList.replace("fa-file-csv", "fa-minus-circle");
                inputField.placeholder = 'Searching by file "' + inputDataFile.files[0].name + '"';
                prevVal = inputField.value;
                inputField.value = "";
                inputField.disabled = true;
                searchFile = true;

                var fr=new FileReader();
                fr.onload=function() {
                    //TODO: data validation
                    searchTerm = fr.result;  
                }
                fr.readAsText(this.files[0]);
            }
        });

        function hideLoading() {
            document.getElementById("my_loading").style.display = "none";
            document.getElementById("myDiv").style.display = "block";
            document.getElementById("my_navbar").classList.replace("navbar-fixed-top", "navbar-static-top");
        }

        function updatePlot() {
            //TODO: centralise file processing before plot updating step
            let entries = searchTerm.split(searchFile ? /\r?\n/ : ',');
            pinned = entries.filter(e => e).map(e => ({row:-1, label: e.trim()}));

            //Find all indices from string
            let indexingColumn = parseInt(searchCols[0]);
            total = 0;
            for(let p of pinned) {
                p.row = matrix[indexingColumn].indexOf(p.label);
                if(p.row != -1) ++total;
            }
            
            lmsPanel.setMultiple(pinned);

            if(pinned.length) $("#myDisplay")[0].setAttribute('data-domain', total + (total == 1 ? " transcript match" : " transcript matches"));
            else $("#myDisplay")[0].setAttribute('data-domain', matrix[0].length + " transcripts");
        }
    </script>
</body>